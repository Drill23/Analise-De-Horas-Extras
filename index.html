<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Analisador de Horas Extras - V3.2 (Imp/Exp JSON)</title> <!-- Versão atualizada -->
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- jsPDF AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <!-- Estilos Otimizados e Corrigidos -->
  <style>
    /* Reset e Configurações Base */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; color: #333; line-height: 1.5; }
    /* Cabeçalho */
    header { background: linear-gradient(135deg, #005bea, #00c6fb); padding: 20px; text-align: center; color: #fff; font-size: 2em; font-weight: 600; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1); border-bottom: 3px solid #004aaa; }
    /* Navegação */
    nav { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; padding: 12px; background-color: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-radius: 8px; max-width: 900px; margin: 15px auto 0 auto; }
    nav button { padding: 10px 18px; font-size: 0.9em; border: 1px solid #b3d4ff; border-radius: 6px; background-color: #e7f3ff; color: #005bea; cursor: pointer; transition: background-color 0.3s, color 0.3s, transform 0.2s; font-weight: 600; }
    nav button:hover { background-color: #005bea; color: #fff; transform: translateY(-2px); box-shadow: 0 3px 6px rgba(0, 91, 234, 0.2); }
    /* Estilo específico para botões de Importar/Exportar */
    nav button.data-mgmt { border-color: #ffc107; background-color: #fff9e6; color: #b88100; }
    nav button.data-mgmt:hover { background-color: #ffc107; color: #333; box-shadow: 0 3px 6px rgba(255, 193, 7, 0.2); }
    /* NOVO: Estilo para botão Apagar Tudo */
    nav button.clear-all-data {
        border-color: #dc3545; /* Vermelho */
        background-color: #f8d7da; /* Vermelho claro */
        color: #842029; /* Vermelho escuro texto */
        font-weight: bold;
    }
    nav button.clear-all-data:hover {
        background-color: #dc3545; /* Vermelho */
        color: #fff;
        box-shadow: 0 3px 6px rgba(220, 53, 69, 0.3);
        transform: translateY(-2px);
    }

    /* Conteúdo Principal */
    main { max-width: 1100px; margin: 20px auto; padding: 0 15px; }
    /* Seções */
    section { background: #ffffff; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06); border: 1px solid #e8e8e8; }
    /* Títulos */
    h2 { color: #005bea; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #eef; font-size: 1.6em; font-weight: 600; }
    h3 { color: #004aaa; margin-bottom: 12px; font-size: 1.3em; }
    h4 { color: #333; margin-top: 18px; margin-bottom: 8px; font-size: 1.1em; font-weight: 600; border-left: 4px solid #00c6fb; padding-left: 8px; }
    h5 { color: #005bea; margin-top: 15px; margin-bottom: 5px; font-size: 1em; font-weight: 600;}
    /* Labels e Inputs */
    label { display: block; margin: 10px 0 5px; font-weight: 600; color: #555; font-size: 0.9em; }
    input[type="text"], input[type="date"], select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 10px; font-size: 0.95em; transition: border-color 0.3s, box-shadow 0.3s; }
    input:focus, textarea:focus, select:focus { border-color: #005bea; box-shadow: 0 0 0 2px rgba(0, 91, 234, 0.15); outline: none; }
    textarea { resize: vertical; min-height: 70px; }
    /* Grupo de Botões */
    .btn-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; align-items: center; }
    /* Botões de Ação */
    button.action { padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; }
    button.action:hover { transform: translateY(-1px); box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
    /* Cores Botões */
    button.save { background-color: #28a745; color: #fff; border-bottom: 2px solid #1e7e34; } button.save:hover { background-color: #218838; }
    button.undo { background-color: #ffc107; color: #212529; border-bottom: 2px solid #d39e00; } button.undo:hover { background-color: #e0a800; }
    button.redo { background-color: #17a2b8; color: #fff; border-bottom: 2px solid #117a8b; } button.redo:hover { background-color: #138496; }
    button.delete { background-color: #dc3545; color: #fff; border-bottom: 2px solid #b02a37; } button.delete:hover { background-color: #c82333; }
    button.export { background-color: #6f42c1; color: #fff; border-bottom: 2px solid #5a32a3; } button.export:hover { background-color: #5a32a3; }
    button.view-details { background-color: #007bff; color: #fff; border-bottom: 2px solid #0056b3; } button.view-details:hover { background-color: #0056b3; }
    button.edit { background-color: #ffc107; color: #212529; border-bottom: 2px solid #d39e00; } button.edit:hover { background-color: #e0a800; }
    button.load { background-color: #007bff; color: #fff; border-bottom: 2px solid #0056b3; } button.load:hover { background-color: #0056b3; }
    button.delete-sector { background-color: #bb2d3b; color: #fff; border-bottom: 2px solid #a0212d; } button.delete-sector:hover { background-color: #a0212d; }
    /* Registros (Pesquisa) */
    .record { border: 1px solid #eee; border-left: 4px solid #00c6fb; padding: 12px; margin-bottom: 12px; border-radius: 6px; background-color: #fdfdfd; }
    .record p { margin-bottom: 5px; font-size: 0.9em; } .record strong { color: #005bea; } .record .action-buttons { margin-top: 8px; }
    /* Dropdown Setor */
    .dropdown { position: relative; width: 100%; }
    .dropdown-content { position: absolute; background: #fff; width: 100%; border: 1px solid #ccc; border-radius: 6px; max-height: 180px; overflow-y: auto; z-index: 100; display: none; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .dropdown-content div { padding: 8px 12px; cursor: pointer; transition: background-color 0.2s; } .dropdown-content div:hover { background: #e7f3ff; color: #005bea; }
    /* Tabelas */
    table { width: 100%; border-collapse: collapse; margin-top: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); font-size: 0.9em; }
    th, td { border: 1px solid #ddd; padding: 8px 10px; text-align: left; }
    th { background-color: #f2f6fc; color: #004aaa; font-weight: 600; text-align: center; }
    td { text-align: center; vertical-align: middle;}
    tbody tr:nth-child(even) { background-color: #f9f9f9; } tbody tr:hover { background-color: #eef; }
    tfoot tr { background-color: #e9ecef; font-weight: bold; }
    tfoot td { text-align: right; padding-right: 10px; color: #004aaa; }
    .table-container { overflow-x: auto; margin-bottom: 15px; }
    /* Canvas (Gráficos) */
    canvas { margin-top: 20px; max-width: 100%; border: 1px solid #eee; border-radius: 8px; padding: 10px; background-color: #fff; display: none; width: 100% !important; height: auto; }
    #reportChart, #sectorChart, #sectorShiftChart, #geralShiftChart { max-height: 400px; }
    #employeeModal canvas#employeeChart { max-height: 280px; display: block; }
    /* Modal Detalhes */
    #employeeModal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background: rgba(0, 0, 0, 0.55); padding-top: 30px; padding-bottom: 30px; }
    #employeeModal .modal-content { background: #fff; margin: 2% auto; padding: 20px; border-radius: 8px; max-width: 750px; position: relative; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); }
    #employeeModal .close { position: absolute; top: 10px; right: 15px; font-size: 1.8em; font-weight: bold; cursor: pointer; color: #aaa; transition: color 0.3s; }
    #employeeModal .close:hover { color: #005bea; }
    #employeeDetails p { margin-bottom: 6px; font-size: 0.95em; } #employeeDetails ul { list-style: none; padding-left: 0; margin-left: 15px; }
    #employeeDetails li { margin-bottom: 4px; position: relative; padding-left: 12px; font-size: 0.95em; } #employeeDetails li::before { content: '•'; position: absolute; left: 0; color: #005bea; font-weight: bold; }
    #employeeModal .action-buttons { margin-top: 8px; margin-bottom: 5px; }
    #employeeModal .management-section p { font-size: 0.9em; white-space: pre-wrap; background-color:#f8f9fa; padding: 8px; border-radius: 4px; border: 1px solid #eee; margin-top: 5px; }
    /* Ajustes Finais */
    #setorReportDiv { margin-top: 15px; padding: 12px; border-radius: 6px; background-color: #f8f9fa; border: 1px solid #eee; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
     #setorReportDiv label { margin-bottom: 0; }
     #setorReportDiv select { margin-bottom: 0; max-width: 250px; }
     #setorReportDiv .action-buttons-inline { margin-top: 0; margin-left: auto; }
    #exportButtonContainer { margin-top: 15px; display: none; }
    hr { border: 0; height: 1px; background-color: #eee; margin: 15px 0; }
    .highlight-box { background-color: #e7f3ff; border: 1px solid #b3d4ff; border-left: 5px solid #005bea; padding: 15px; margin-top: 20px; border-radius: 6px; }
    .highlight-box p { margin-bottom: 5px; } .highlight-box strong { color: #004aaa; }
    .management-section { margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ccc; }
    .management-section textarea { margin-top: 5px;}
    .shift-comparison-section { margin-top: 25px; padding: 15px; border: 1px solid #17a2b8; border-radius: 8px; background-color: #f0fbfc; }
    .shift-comparison-section h4 { border-left-color: #17a2b8; color: #117a8b; }
    .shift-comparison-section p { font-size: 0.95em; margin-bottom: 8px; }
     #deleteSectorDataButton { display: none; }
  </style>
</head>
<body>
  <header>Analisador de Horas Extras - V3.2 (Imp/Exp JSON)</header>
  <nav>
    <button onclick="showSection('dataEntry')">Entrada</button>
    <button onclick="showSection('searchEdit')">Pesquisar/Editar</button>
    <button onclick="showSection('reports')">Relatórios</button>
    <button onclick="gerarRelatorio('comparativoTurnos')">Comparar Turnos (Geral)</button>
    <button onclick="salvarManual()">Salvar Manual</button>
    <!-- BOTÕES IMPORTAR/EXPORTAR -->
    <button class="data-mgmt" onclick="exportarDadosJSON()">Exportar Dados</button>
    <button class="data-mgmt" onclick="iniciarImportacaoJSON()">Importar Dados</button>
    <!-- NOVO BOTÃO PARA APAGAR TODOS OS DADOS -->
    <button class="clear-all-data" onclick="apagarTodosOsDados()">Apagar Todos os Dados</button>
  </nav>

  <!-- Input oculto para seleção de arquivo JSON -->
  <input type="file" id="importFile" accept=".json" style="display: none;">

  <main>
    <!-- Seção de Entrada de Dados -->
    <section id="dataEntry">
       <h2>Entrada de Dados</h2>
       <!-- Campos do formulário de entrada sem alterações -->
       <label for="matriculas">Matrículas:</label>
       <textarea id="matriculas" placeholder="Ex.: 58759, 59870 ou 5875959870"></textarea>
       <label for="nomes">Nomes (ordem correspondente):</label>
       <textarea id="nomes" placeholder="Ex.: João Silva, Maria Souza"></textarea>
       <label for="antiJornada">HE Anti Jornada 50% (000.08 ou 0:08):</label>
       <textarea id="antiJornada" placeholder="Ex.: 000.08, 0:34"></textarea>
       <label for="porJornada">HE Por Jornada 50% (000.08 ou 0:08):</label>
       <textarea id="porJornada" placeholder="Ex.: 000.00, 0:45"></textarea>
       <label for="extra75">HE 75% (001.15 ou 1:15):</label>
       <textarea id="extra75" placeholder="Ex.: 001.15"></textarea>
       <label for="extra80">HE 80% (000.30 ou 0:30):</label>
       <textarea id="extra80" placeholder="Ex.: 000.30"></textarea>
       <label for="extra100">HE 100% (000.20 ou 0:20):</label>
       <textarea id="extra100" placeholder="Ex.: 000.20"></textarea>
       <label for="turno">Turno:</label>
       <select id="turno">
         <option value="1">1° Turno</option> <option value="2">2° Turno</option>
         <option value="3">3° Turno</option> <option value="ADM">ADM</option>
         <option value="Geral">Geral</option>
       </select>
       <label for="setorInput">Setor:</label>
       <div class="dropdown">
         <input type="text" id="setorInput" placeholder="Selecione ou digite o setor">
         <div class="dropdown-content" id="setorDropdown"></div>
       </div>
       <label for="data">Data Registro:</label>
       <input type="date" id="data">
       <div class="btn-group">
         <button class="action save" onclick="salvar()">Salvar</button>
         <button class="action undo" onclick="undoAction()">Desfazer</button>
         <button class="action redo" onclick="redoAction()">Refazer</button>
         <button class="action delete" onclick="limparFormulario()">Limpar</button>
       </div>
     </section>

    <!-- Seção de Pesquisa / Edição -->
    <section id="searchEdit" style="display: none;">
       <h2>Pesquisar / Editar Registros</h2>
       <!-- Campos de pesquisa sem alterações -->
      <label for="searchQuery">Buscar por Matrícula ou Nome:</label>
      <input type="text" id="searchQuery" placeholder="Digite a matrícula ou parte do nome">
      <div class="btn-group"> <button class="action load" onclick="pesquisar()">Pesquisar</button> </div>
      <div id="searchResults" style="margin-top: 15px;"></div>
    </section>

    <!-- Seção de Relatórios -->
    <section id="reports" style="display: none;">
      <h2>Relatórios</h2>
      <div class="btn-group">
        <button class="action load" onclick="gerarRelatorio('individual')">Individual</button>
        <button class="action load" onclick="mostrarRelatorioSetor()">Por Setor</button>
        <button class="action load" onclick="gerarRelatorio('geral')">Geral Consolidado</button>
      </div>
      <!-- Div para seleção de setor e botão de exclusão -->
      <div id="setorReportDiv" style="display: none;">
        <label for="reportSetorSelect">Selecione o Setor:</label>
        <select id="reportSetorSelect"> <option value="">-- Selecione --</option> </select>
        <div class="action-buttons-inline">
            <button class="action load" onclick="gerarRelatorio('setor')">Carregar</button>
            <button id="deleteSectorDataButton" class="action delete-sector" style="display: none;" onclick="">Excluir Dados Deste Setor</button>
        </div>
      </div>
      <div id="reportContent" style="margin-top: 20px;"></div>
      <!-- Canvas para os gráficos -->
      <canvas id="reportChart"></canvas> <canvas id="sectorChart"></canvas>
      <canvas id="sectorShiftChart"></canvas> <canvas id="geralShiftChart"></canvas>
      <div id="exportButtonContainer" class="btn-group">
        <button class="action export" onclick="exportCurrentReport()">Exportar PDF</button>
      </div>
    </section>
  </main>

  <!-- Modal Detalhes Colaborador -->
  <div id="employeeModal">
    <div class="modal-content">
      <span class="close" onclick="closeEmployeeModal()">×</span>
      <div id="employeeDetails"></div>
      <canvas id="employeeChart"></canvas>
      <div id="justificationSection" class="management-section">
         <h5>Justificativas Associadas</h5>
         <div> <strong>Justificativa do Setor (<span id="modalSetorName"></span>):</strong> <p id="modalSectorJustification"></p> </div> <hr style="margin: 8px 0;">
         <div> <strong>Justificativa Individual (<span id="modalMatricula"></span>):</strong> <p id="modalIndividualJustificationDisplay" style="display: none;"></p> <textarea id="modalIndividualJustificationInput"></textarea> <div class="action-buttons" style="margin-top: 5px;"> <button class="action save" onclick="salvarJustificativaIndividualModal()">Salvar Justif. Ind.</button> <button class="action delete" onclick="excluirJustificativaIndividualModal()">Excluir Justif. Ind.</button> </div> </div>
      </div>
      <div id="employeePlanSection" class="management-section"></div>
      <div class="btn-group" style="margin-top:15px; border-top: 1px solid #eee; padding-top: 10px;"> <button class="action export" onclick="exportEmployeeReport()">Exportar Detalhes PDF</button> </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // Variáveis globais (incluindo as novas para justificativas)
    let registros = [];
    let undoStack = []; let redoStack = [];
    let planoAcaoGeral = ""; let planoAcaoDepartamento = {}; let planoAcaoIndividual = {};
    let justificativaDepartamento = {}; // NOVO
    let justificativaIndividual = {}; // NOVO
    let currentReportType = null; let currentReportData = null; let currentReportTitle = ""; let currentReportSetor = "";
    let chartInstanceReport = null; let chartInstanceSector = null; let chartInstanceSectorShift = null; let chartInstanceGeralShift = null; let chartInstanceEmployee = null;

    // Lista base de setores (MODIFICADA PARA INCLUIR "Asa")
    const setoresBase = ["Plataforma", "Pendura", "Escaldagem/Depenagem", "Evisceração", "Re-pendura", "Miúdos", "Padronização", "Espostejamento 1", "Espostejamento 2", "Asa", "Embalagem Primária", "Embalagem Secundária", "Montagem de Caixas", "Embalagem de Cortes", "CMS", "Peito/Filé (SBB)", "Bandeja", "Serviço de Inspeção", "Higienização Operacional", "Expedição", "Manutenção", "Qualidade", "Geral", "Tunel", "Paletização", "Frango Inteiro", "Higienização Externa"];

    // Carrega dados ao iniciar (incluindo justificativas)
    window.onload = function() {
        const storedRegistros = localStorage.getItem("registros"); 
        if (storedRegistros) try { 
          registros = JSON.parse(storedRegistros); 
          registros.forEach(r => { 
            r.horas = r.horas || {}; 
            r.horas.anti = Number(r.horas.anti) || 0; 
            r.horas.por = Number(r.horas.por) || 0; 
            r.horas.extra75 = Number(r.horas.extra75) || 0; 
            r.horas.extra80 = Number(r.horas.extra80) || 0; 
            r.horas.extra100 = Number(r.horas.extra100) || 0; 
            if (r.setor) r.setor = r.setor.charAt(0).toUpperCase() + r.setor.slice(1).toLowerCase(); else r.setor = "Indefinido"; 
            if (!r.turno) r.turno = "Geral"; 
          }); 
        } catch (e) { 
          console.error("Erro ao carregar registros:", e); 
          registros = []; 
        }
        const storedPlanosSetor = localStorage.getItem("planosSetor"); 
        if (storedPlanosSetor) try { 
          planoAcaoDepartamento = JSON.parse(storedPlanosSetor); 
        } catch(e){ 
          console.error("Erro ao carregar planos de setor:", e); 
          planoAcaoDepartamento = {}; 
        }
        const storedPlanoGeral = localStorage.getItem("planoGeral"); 
        if (storedPlanoGeral) 
           planoAcaoGeral = storedPlanoGeral; 
        else 
           planoAcaoGeral = "";
        const storedPlanosInd = localStorage.getItem("planosIndividuais"); 
        if (storedPlanosInd) try { 
          planoAcaoIndividual = JSON.parse(storedPlanosInd); 
        } catch(e){ 
          console.error("Erro ao carregar planos individuais:", e); 
          planoAcaoIndividual = {}; 
        }
        const storedJustSetor = localStorage.getItem("justificativasSetor"); 
        if (storedJustSetor) try { 
          justificativaDepartamento = JSON.parse(storedJustSetor); 
        } catch(e){ 
          console.error("Erro ao carregar justificativas de setor:", e); 
          justificativaDepartamento = {}; 
        }
        const storedJustInd = localStorage.getItem("justificativasIndividuais"); 
        if (storedJustInd) try { 
          justificativaIndividual = JSON.parse(storedJustInd); 
        } catch(e){ 
          console.error("Erro ao carregar justificativas individuais:", e); 
          justificativaIndividual = {}; 
        }

        populateSetorDropdowns();
        salvarEstado(false); // Salva estado inicial para histórico de Desfazer
        document.getElementById("data").valueAsDate = new Date();

        // Adiciona o listener para o input de importação
        document.getElementById('importFile').addEventListener('change', importarDadosJSON);

        // --- NOVA: Carregamento automático do arquivo JSON "dados.json" ---
        fetch('dados.json')
          .then(response => {
              if (!response.ok) {
                  throw new Error('Erro na requisição: ' + response.status);
              }
              return response.json();
          })
          .then(data => {
              // Atualiza as variáveis globais com os dados importados, se presentes
              if(data.registros) registros = data.registros;
              if(data.planoAcaoGeral !== undefined) planoAcaoGeral = data.planoAcaoGeral;
              if(data.planoAcaoDepartamento) planoAcaoDepartamento = data.planoAcaoDepartamento;
              if(data.planoAcaoIndividual) planoAcaoIndividual = data.planoAcaoIndividual;
              if(data.justificativaDepartamento) justificativaDepartamento = data.justificativaDepartamento;
              if(data.justificativaIndividual) justificativaIndividual = data.justificativaIndividual;
              salvarEstado(true); // Salva o estado atualizado (e limpa o redoStack)
              populateSetorDropdowns();
              alert("Dados do JSON foram carregados com sucesso!");
          })
          .catch(error => {
              console.error("Erro ao carregar dados.json:", error);
              // Opcional: alert("Erro ao carregar dados do JSON.");
          });
        // --- Fim do novo código de importação automática ---
     };

    // Preenche dropdowns de setor
    function populateSetorDropdowns() { /* ... código sem alteração ... */ const setorDropdownEntrada = document.getElementById("setorDropdown"); const setorSelectRelatorio = document.getElementById("reportSetorSelect"); setorSelectRelatorio.innerHTML = '<option value="">-- Selecione --</option>'; setorDropdownEntrada.innerHTML = ''; const setoresRegistros = [...new Set(registros.map(r => r.setor.trim()))].filter(s => s); const setoresCombinadosMap = new Map(); [...setoresBase, ...setoresRegistros].forEach(setor => { const setorLower = setor.toLowerCase(); if (!setoresCombinadosMap.has(setorLower)) { setoresCombinadosMap.set(setorLower, setor.charAt(0).toUpperCase() + setor.slice(1).toLowerCase()); } }); const setoresUnicosOrdenados = Array.from(setoresCombinadosMap.values()).sort((a, b) => a.localeCompare(b)); setoresUnicosOrdenados.forEach(setorCapitalizado => { const div = document.createElement('div'); div.textContent = setorCapitalizado; div.onclick = () => selectSetor(div); setorDropdownEntrada.appendChild(div); const option = document.createElement('option'); option.value = setorCapitalizado.toLowerCase(); option.textContent = setorCapitalizado; setorSelectRelatorio.appendChild(option); }); }

    // Alterna seções visíveis
    function showSection(sectionId) { /* ... código sem alteração ... */ document.querySelectorAll('main section').forEach(sec => sec.style.display = 'none'); document.getElementById(sectionId).style.display = 'block'; if (sectionId !== 'reports') { document.getElementById("setorReportDiv").style.display = "none"; document.getElementById("reportContent").innerHTML = ""; hideChartsAndExportButton(); currentReportType = null; } }

    // Dropdown de setor na entrada (interação)
    function selectSetor(element) { /* ... código sem alteração ... */ document.getElementById("setorInput").value = element.textContent; document.getElementById("setorDropdown").style.display = "none"; }
    const setorInput = document.getElementById("setorInput"); const setorDropdown = document.getElementById("setorDropdown"); setorInput.addEventListener("focus", () => { filterSetorDropdown(); setorDropdown.style.display = "block"; }); setorInput.addEventListener("blur", () => setTimeout(() => { if (!setorDropdown.contains(document.activeElement)) { setorDropdown.style.display = "none"; } }, 150)); setorInput.addEventListener("input", filterSetorDropdown); function filterSetorDropdown() { /* ... código sem alteração ... */ const filter = setorInput.value.toLowerCase(); const divs = setorDropdown.getElementsByTagName('div'); let anyVisible = false; for (let i = 0; i < divs.length; i++) { const txtValue = divs[i].textContent || divs[i].innerText; const isVisible = txtValue.toLowerCase().indexOf(filter) > -1; divs[i].style.display = isVisible ? "" : "none"; if (isVisible) anyVisible = true; } setorDropdown.style.display = anyVisible ? "block" : "none"; }

    // Limpar Formulário de Entrada
    function limparFormulario() { /* ... código sem alteração ... */ document.getElementById("matriculas").value = ""; document.getElementById("nomes").value = ""; document.getElementById("antiJornada").value = ""; document.getElementById("porJornada").value = ""; document.getElementById("extra75").value = ""; document.getElementById("extra80").value = ""; document.getElementById("extra100").value = ""; document.getElementById("turno").selectedIndex = 0; document.getElementById("setorInput").value = ""; document.getElementById("data").valueAsDate = new Date(); }

    // Salvar Manualmente no LocalStorage (incluindo justificativas)
    function salvarManual() {
        try {
            localStorage.setItem("registros", JSON.stringify(registros));
            localStorage.setItem("planosSetor", JSON.stringify(planoAcaoDepartamento));
            localStorage.setItem("planoGeral", planoAcaoGeral);
            localStorage.setItem("planosIndividuais", JSON.stringify(planoAcaoIndividual));
            localStorage.setItem("justificativasSetor", JSON.stringify(justificativaDepartamento));
            localStorage.setItem("justificativasIndividuais", JSON.stringify(justificativaIndividual));
            alert("Dados salvos manualmente com sucesso!");
        } catch (error) { console.error("Erro ao salvar manualmente:", error); alert("Erro ao salvar dados."); }
    }

    // Salva estado para Undo/Redo e no LocalStorage (incluindo justificativas)
    function salvarEstado(clearRedo = true) {
        const estadoAtual = JSON.stringify({
            registros: registros,
            planosSetor: planoAcaoDepartamento, planoGeral: planoAcaoGeral, planosIndividuais: planoAcaoIndividual,
            justificativasSetor: justificativaDepartamento,
            justificativasIndividuais: justificativaIndividual
        });
        if (undoStack.length === 0 || undoStack[undoStack.length - 1] !== estadoAtual) {
           undoStack.push(estadoAtual);
            if (undoStack.length > 15) {
                undoStack.shift();
            }
            if (clearRedo) {
                redoStack = [];
            }
        }
         try {
             localStorage.setItem("registros", JSON.stringify(registros));
             localStorage.setItem("planosSetor", JSON.stringify(planoAcaoDepartamento));
             localStorage.setItem("planoGeral", planoAcaoGeral);
             localStorage.setItem("planosIndividuais", JSON.stringify(planoAcaoIndividual));
             localStorage.setItem("justificativasSetor", JSON.stringify(justificativaDepartamento));
             localStorage.setItem("justificativasIndividuais", JSON.stringify(justificativaIndividual));
         } catch (error) {
             console.error("Erro ao salvar estado no LocalStorage:", error);
             alert("Atenção: Não foi possível salvar os dados automaticamente. Tente 'Salvar Manual'.");
         }
    }

    // Desfazer Ação (incluindo justificativas)
    function undoAction() {
        if (undoStack.length > 1) {
            redoStack.push(undoStack.pop());
            const estadoAnterior = JSON.parse(undoStack[undoStack.length - 1]);
            registros = estadoAnterior.registros || [];
            planoAcaoDepartamento = estadoAnterior.planosSetor || {};
            planoAcaoGeral = estadoAnterior.planoGeral || "";
            planoAcaoIndividual = estadoAnterior.planosIndividuais || {};
            justificativaDepartamento = estadoAnterior.justificativasSetor || {};
            justificativaIndividual = estadoAnterior.justificativasIndividuais || {};
            salvarManual();
            alert("Ação desfeita.");
            if (document.getElementById("searchEdit").style.display === 'block') pesquisar();
            if (document.getElementById("reports").style.display === 'block') refreshCurrentReport();
             populateSetorDropdowns();
        } else { alert("Nada a desfazer."); }
    }

    // Refazer Ação (incluindo justificativas)
    function redoAction() {
        if (redoStack.length > 0) {
            const estadoRefeitoStr = redoStack.pop();
            const estadoRefeito = JSON.parse(estadoRefeitoStr);
            undoStack.push(estadoRefeitoStr);
            registros = estadoRefeito.registros || [];
            planoAcaoDepartamento = estadoRefeito.planosSetor || {};
            planoAcaoGeral = estadoRefeito.planoGeral || "";
            planoAcaoIndividual = estadoRefeito.planosIndividuais || {};
            justificativaDepartamento = estadoRefeito.justificativasSetor || {};
            justificativaIndividual = estadoRefeito.justificativasIndividuais || {};
            salvarManual();
            alert("Ação refeita.");
            if (document.getElementById("searchEdit").style.display === 'block') pesquisar();
            if (document.getElementById("reports").style.display === 'block') refreshCurrentReport();
             populateSetorDropdowns();
        } else { alert("Nada a refazer."); }
    }

    // Atualiza o relatório atual
    function refreshCurrentReport() { /* ... código sem alteração ... */ if (currentReportType) { if (currentReportType === 'setor') { const selectSetor = document.getElementById("reportSetorSelect"); if (selectSetor.value === currentReportSetor) { gerarRelatorio('setor'); } else { document.getElementById("reportContent").innerHTML = ""; hideChartsAndExportButton(); } } else { gerarRelatorio(currentReportType); } } else { document.getElementById("reportContent").innerHTML = ""; hideChartsAndExportButton(); } }

    // Funções Auxiliares de Parsing e Formatação
    function splitInput(input) { return input.split(/[\n,]+/).map(s => s.trim()).filter(s => s !== ""); }
    function parseMatriculas(input) { let lines = splitInput(input); let result = []; lines.forEach(item => { let cleanedItem = item.replace(/\s/g, ''); if (/^\d+$/.test(cleanedItem)) { if (cleanedItem.length > 5 && cleanedItem.length % 5 === 0) { for (let j = 0; j < cleanedItem.length; j += 5) { result.push(cleanedItem.substr(j, 5)); } } else if (cleanedItem.length > 0) { result.push(cleanedItem); } } else if (item) { result.push(item); } }); return result; }
    function parseNomes(input) { return splitInput(input); }
    function parseHoras(input) { let lines = splitInput(input); let result = []; lines.forEach(item => { item = item.replace(",", "."); let totalMinutes = 0; if (item.includes(':')) { let parts = item.split(':'); if (parts.length === 2) { totalMinutes = (parseInt(parts[0], 10) || 0) * 60 + (parseInt(parts[1], 10) || 0); } } else if (item.includes('.')) { let parts = item.split('.'); if (parts.length === 2) { let hours = parseInt(parts[0], 10) || 0; let fraction = parts[1]; if (fraction.length <= 2 && parseInt(fraction, 10) < 60) { totalMinutes = hours * 60 + (parseInt(fraction, 10) || 0); } else { totalMinutes = Math.round(parseFloat(item) * 60); } } else if (parts.length === 1 && !isNaN(parseFloat(item))) { totalMinutes = Math.round(parseFloat(item) * 60); } } else if (/^\d+$/.test(item)) { totalMinutes = parseInt(item, 10) || 0; } result.push(isNaN(totalMinutes) ? 0 : totalMinutes); }); return result; }
    function formatTime(totalMinutes) { if (isNaN(totalMinutes) || totalMinutes <= 0) return "0 min"; totalMinutes = Math.round(totalMinutes); if (totalMinutes < 1) return "0 min"; if (totalMinutes < 60) return totalMinutes + " min"; let hours = Math.floor(totalMinutes / 60); let minutes = totalMinutes % 60; return hours + " h" + (minutes > 0 ? " " + minutes + " min" : ""); }
    function dataFormatada(dataString) { if (!dataString) return 'N/A'; const [y, m, d] = dataString.split('-'); return `${d}/${m}/${y}`; }

    // Salvar Novos Registros
    function salvar() {
        let matriculasParsed = parseMatriculas(document.getElementById("matriculas").value);
        let nomesParsed = parseNomes(document.getElementById("nomes").value);
        let horasAnti = parseHoras(document.getElementById("antiJornada").value);
        let horasPor = parseHoras(document.getElementById("porJornada").value);
        let horas75 = parseHoras(document.getElementById("extra75").value);
        let horas80 = parseHoras(document.getElementById("extra80").value);
        let horas100 = parseHoras(document.getElementById("extra100").value);
        let turnoSel = document.getElementById("turno").value;
        let setorInputVal = document.getElementById("setorInput").value.trim();
        let dataSel = document.getElementById("data").value;
        if (!matriculasParsed.length || !nomesParsed.length) { alert("Matrículas e Nomes obrigatórios."); return; }
        if (matriculasParsed.length !== nomesParsed.length) { alert(`Erro: Número de Matrículas (${matriculasParsed.length}) diferente do número de Nomes (${nomesParsed.length}).`); return; }
        if (!setorInputVal) { alert("Setor obrigatório."); return; }
        if (!dataSel) { alert("Data obrigatória."); return; }
        const numEntradas = matriculasParsed.length;
        while (horasAnti.length < numEntradas) horasAnti.push(0);
        while (horasPor.length < numEntradas) horasPor.push(0);
        while (horas75.length < numEntradas) horas75.push(0);
        while (horas80.length < numEntradas) horas80.push(0);
        while (horas100.length < numEntradas) horas100.push(0);
        let novosRegistros = [];
        let duplicadosIgnorados = 0;
        let confirmouDuplicados = false;
        let perguntouSobreDuplicados = false;
        let setorCapitalizado = setorInputVal.charAt(0).toUpperCase() + setorInputVal.slice(1).toLowerCase();
        for (let i = 0; i < numEntradas; i++) {
            let novoReg = {
              id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
              matricula: matriculasParsed[i],
              nome: nomesParsed[i],
              turno: turnoSel,
              setor: setorCapitalizado,
              data: dataSel,
              horas: {
                  anti: horasAnti[i] || 0,
                  por: horasPor[i] || 0,
                  extra75: horas75[i] || 0,
                  extra80: horas80[i] || 0,
                  extra100: horas100[i] || 0
              }
            };
            let duplicado = registros.find(r => r.matricula === novoReg.matricula && r.data === novoReg.data);
            if (duplicado) {
                if (!perguntouSobreDuplicados) {
                    confirmouDuplicados = confirm(`Registros duplicados (ex: matrícula ${novoReg.matricula} na data ${dataFormatada(novoReg.data)}) foram encontrados.\n\nDeseja adicionar mesmo assim, criando entradas duplicadas para o mesmo dia/colaborador?`);
                    perguntouSobreDuplicados = true;
                }
                if (!confirmouDuplicados) { duplicadosIgnorados++; continue; }
            }
            novosRegistros.push(novoReg);
        }
        if (novosRegistros.length > 0) {
            registros = registros.concat(novosRegistros);
            salvarEstado();
            alert(`${novosRegistros.length} registro(s) salvo(s) com sucesso!` + (duplicadosIgnorados > 0 ? `\n${duplicadosIgnorados} registro(s) duplicado(s) foram ignorados.` : ""));
            limparFormulario();
            populateSetorDropdowns();
        } else {
            alert("Nenhum registro novo foi adicionado." + (duplicadosIgnorados > 0 ? ` ${duplicadosIgnorados} registro(s) duplicado(s) foram ignorados.` : ""));
        }
    }

    // Pesquisar / Exibir / Editar / Excluir Registro
    function pesquisar(){
        let query = document.getElementById("searchQuery").value.toLowerCase().trim();
        let resultados = [];
        if (query) { resultados = registros.filter(r => r.nome.toLowerCase().includes(query) || (r.matricula && r.matricula.toLowerCase().includes(query))).sort((a, b) => new Date(b.data) - new Date(a.data)); }
        exibirResultados(resultados);
    }
    function exibirResultados(resultados){
        let container = document.getElementById("searchResults");
        container.innerHTML = "";
        if (!resultados.length) { container.innerHTML = "<p>Nenhum registro encontrado.</p>"; return; }
        resultados.forEach((reg) => {
            let div = document.createElement("div");
            div.className = "record";
            let totalHoras = Object.values(reg.horas).reduce((s, h) => s + (h || 0), 0);
            const dataFmt = dataFormatada(reg.data);
            const regJson = JSON.stringify(reg).replace(/"/g, '"');
            div.innerHTML = `<p><strong>Mat:</strong> ${reg.matricula} | <strong>Nome:</strong> ${reg.nome}</p><p><strong>Setor:</strong> ${reg.setor} | <strong>Turno:</strong> ${reg.turno} | <strong>Data:</strong> ${dataFmt}</p><p style="font-size:0.85em;">H: A:${formatTime(reg.horas.anti)}|P:${formatTime(reg.horas.por)}|75:${formatTime(reg.horas.extra75)}|80:${formatTime(reg.horas.extra80)}|100:${formatTime(reg.horas.extra100)}</p><p><strong>Total Dia:</strong> ${formatTime(totalHoras)}</p><div class="action-buttons"><button class="action edit" onclick='editarRegistro("${reg.id}")'>Editar</button><button class="action delete" onclick='excluirRegistro("${reg.id}")'>Excluir</button><button class="action view-details" onclick='viewEmployeeDetails(${regJson})'>Detalhes</button></div>`;
            container.appendChild(div);
        });
    }
    function editarRegistro(id){
        let index = registros.findIndex(r => r.id === id);
        if (index === -1) { alert("Erro: Registro não encontrado."); return; }
        let registro = registros[index];
        let novoNome = prompt("Editar Nome:", registro.nome);
        if (novoNome === null) { alert("Edição cancelada."); return; }
        let novoSetor = prompt("Editar Setor:", registro.setor);
        if (novoSetor === null) { alert("Edição cancelada."); return; }
        let novaData = prompt("Editar Data (AAAA-MM-DD):", registro.data);
        if (novaData === null) { alert("Edição cancelada."); return; }
        if (!/^\d{4}-\d{2}-\d{2}$/.test(novaData) || isNaN(new Date(novaData))) { alert("Formato de data inválido. Use AAAA-MM-DD."); return; }
        const nomeTrimmed = novoNome.trim();
        const setorTrimmed = novoSetor.trim();
        const setorCapitalizado = setorTrimmed.charAt(0).toUpperCase() + setorTrimmed.slice(1).toLowerCase();
        if (registro.nome !== nomeTrimmed || registro.setor !== setorCapitalizado || registro.data !== novaData) {
            registros[index] = { ...registro, nome: nomeTrimmed, setor: setorCapitalizado, data: novaData };
            salvarEstado();
            alert("Registro atualizado.");
            pesquisar();
            populateSetorDropdowns();
            refreshCurrentReport();
        } else { alert("Nenhuma alteração detectada."); }
    }
    function excluirRegistro(id){
        if (confirm("Tem certeza que deseja excluir este registro específico?")) {
            const tamanhoAntes = registros.length;
            registros = registros.filter(r => r.id !== id);
            if (registros.length < tamanhoAntes) { salvarEstado(); alert("Registro excluído com sucesso."); pesquisar(); populateSetorDropdowns(); refreshCurrentReport(); } else { alert("Erro: Registro não encontrado para exclusão."); }
        }
    }

    // Mostrar Opções de Relatório por Setor e Botão Excluir
    function mostrarRelatorioSetor() { document.getElementById("setorReportDiv").style.display = "flex"; document.getElementById("reportContent").innerHTML = ""; hideChartsAndExportButton(); document.getElementById("deleteSectorDataButton").style.display = "none"; currentReportType = null; }

    // Esconder Gráficos e Botão Exportar
    function hideChartsAndExportButton() {
         if (chartInstanceReport) { chartInstanceReport.destroy(); chartInstanceReport = null; }
         if (chartInstanceSector) { chartInstanceSector.destroy(); chartInstanceSector = null; }
         if (chartInstanceSectorShift) { chartInstanceSectorShift.destroy(); chartInstanceSectorShift = null; }
         if (chartInstanceGeralShift) { chartInstanceGeralShift.destroy(); chartInstanceGeralShift = null; }
         document.getElementById("reportChart").style.display = 'none';
         document.getElementById("sectorChart").style.display = 'none';
         document.getElementById("sectorShiftChart").style.display = 'none';
         document.getElementById("geralShiftChart").style.display = 'none';
         document.getElementById("exportButtonContainer").style.display = 'none';
         document.getElementById("deleteSectorDataButton").style.display = 'none';
    }

    // --- Geração de Relatórios (com Justificativas e Total Top 3) ---
    function gerarRelatorio(tipo) { /* ... código existente sem alterações ... */
        let container = document.getElementById("reportContent"); container.innerHTML = "Gerando...";
        hideChartsAndExportButton(); 
        currentReportData = null; currentReportTitle = ""; currentReportSetor = "";
        let filtro = []; let titulo = ""; let html = "";
        showSection('reports');

        try {
            if (tipo === "individual") {
                 let query = prompt("Digite a Matrícula ou Nome para buscar:"); if (query === null) { container.innerHTML = "<p>Busca cancelada.</p>"; currentReportType = null; return; } query = query.toLowerCase().trim(); if (!query) { container.innerHTML = "<p>É necessário digitar um termo para a busca.</p>"; currentReportType = null; return; }
                 filtro = registros.filter(r => r.nome.toLowerCase().includes(query) || (r.matricula && r.matricula.toLowerCase().includes(query)));
                 if (!filtro.length) { container.innerHTML = `<p>Nenhum registro encontrado para "${query}".</p>`; currentReportType = null; return; }
                 const colab = filtro[0];
                 titulo = `Relatório Individual - ${colab.nome} (${colab.matricula})`;
                 let totalGeralInd = filtro.reduce((acc, r) => acc + Object.values(r.horas).reduce((s, h) => s + (h || 0), 0), 0);
                 currentReportTitle = `${titulo} | Total Acumulado: ${formatTime(totalGeralInd)}`;
                 html = `<h3 style="margin-bottom: 10px;">${currentReportTitle}</h3>`;
                 const justSetor = justificativaDepartamento[colab.setor.toLowerCase()] || "Nenhuma justificativa de setor associada.";
                 const justInd = justificativaIndividual[colab.matricula] || "Nenhuma justificativa individual associada.";
                 html += `<div class="management-section" style="border:none; padding-top:0;"><h5>Justificativas</h5><p><strong>Setor (${colab.setor}):</strong> ${justSetor}</p><p style="margin-top:5px;"><strong>Individual:</strong> ${justInd}</p></div><hr>`;
                 html += `<h4>Registros Detalhados</h4><div class="table-container"><table><thead><tr><th>Data</th><th>Setor</th><th>Anti</th><th>Por</th><th>75%</th><th>80%</th><th>100%</th><th>Total Dia</th></tr></thead><tbody>`;
                 filtro.sort((a, b) => new Date(a.data) - new Date(b.data)).forEach(r => { let t=Object.values(r.horas).reduce((s, h) => s + (h || 0), 0); html += `<tr><td>${dataFormatada(r.data)}</td><td>${r.setor}</td><td>${formatTime(r.horas.anti)}</td><td>${formatTime(r.horas.por)}</td><td>${formatTime(r.horas.extra75)}</td><td>${formatTime(r.horas.extra80)}</td><td>${formatTime(r.horas.extra100)}</td><td><strong>${formatTime(t)}</strong></td></tr>`; });
                 html += `</tbody></table></div>`;
                 container.innerHTML = html;
                 currentReportType = 'individual';
                 currentReportData = { registros: filtro, justificativaSetor: justSetor, justificativaIndividual: justInd };
                 gerarGraficoPrincipal(filtro, "reportChart");
            } else if (tipo === "setor") {
                 let setorSelValue = document.getElementById("reportSetorSelect").value; if (!setorSelValue) { container.innerHTML = "<p>Por favor, selecione um setor.</p>"; currentReportType = null; return; } currentReportSetor = setorSelValue;
                 filtro = registros.filter(r => r.setor.toLowerCase() === setorSelValue);
                 let nomeSetorDisplay = "Setor"; const selOpt = document.getElementById("reportSetorSelect").options[document.getElementById("reportSetorSelect").selectedIndex]; if(selOpt && selOpt.value === setorSelValue) nomeSetorDisplay = selOpt.text;
                 if (!filtro.length) { container.innerHTML = `<p>Nenhum registro encontrado para o setor "${nomeSetorDisplay}".</p>`; document.getElementById("deleteSectorDataButton").style.display = 'none'; currentReportType = null; return; }
                 titulo = `Relatório do Setor: ${nomeSetorDisplay}`;
                 let totalHorasSetor = filtro.reduce((acc, r) => acc + Object.values(r.horas).reduce((s, h) => s + (h || 0), 0), 0);
                 currentReportTitle = `${titulo} | Total Horas: ${formatTime(totalHorasSetor)}`;
                 html = `<h3 style="margin-bottom: 10px;">${currentReportTitle}</h3>`;
                 html += `<h4>Registros Detalhados</h4><div class="table-container"><table><thead><tr><th>Mat.</th><th>Nome</th><th>Turno</th><th>Data</th><th>Anti</th><th>Por</th><th>75%</th><th>80%</th><th>100%</th><th>Total</th><th>Ações</th></tr></thead><tbody>`;
                 filtro.sort((a, b) => new Date(b.data) - new Date(a.data)).forEach(r => { let t=Object.values(r.horas).reduce((s, h) => s + (h || 0), 0); const rJson = JSON.stringify(r).replace(/"/g, '"'); html += `<tr><td>${r.matricula}</td><td>${r.nome}</td><td>${r.turno || 'N/A'}</td><td>${dataFormatada(r.data)}</td><td>${formatTime(r.horas.anti)}</td><td>${formatTime(r.horas.por)}</td><td>${formatTime(r.horas.extra75)}</td><td>${formatTime(r.horas.extra80)}</td><td>${formatTime(r.horas.extra100)}</td><td><strong>${formatTime(t)}</strong></td><td><button class="action view-details" style="padding: 4px 8px; font-size: 0.75em;" onclick='viewEmployeeDetails(${rJson})'>Detalhes</button></td></tr>`; });
                 html += `</tbody></table></div>`;
                 let rankingSetor = {}; filtro.forEach(r => { let k=r.matricula; let tC=Object.values(r.horas).reduce((s,h)=>s+h,0); if(!rankingSetor[k]) rankingSetor[k]={m:r.matricula, n:r.nome, t:0, h:{a:0,p:0,e75:0,e80:0,e100:0}}; rankingSetor[k].t+=tC; rankingSetor[k].h.a+=(r.horas.anti||0); rankingSetor[k].h.p+=(r.horas.por||0); rankingSetor[k].h.e75+=(r.horas.extra75||0); rankingSetor[k].h.e80+=(r.horas.extra80||0); rankingSetor[k].h.e100+=(r.horas.extra100||0); });
                 let top3Setor = Object.values(rankingSetor).sort((a, b) => b.t - a.t).slice(0, 3); let totalHorasTop3Setor = 0;
                 if (top3Setor.length > 0) {
                    html += `<h4 style="margin-top: 20px;">Top 3 Colaboradores (Horas no Setor)</h4><div class="table-container"><table><thead><tr><th>Pos.</th><th>Mat.</th><th>Nome</th><th>Total</th><th>Detalhes (A|P|75|80|100)</th></tr></thead><tbody>`;
                    top3Setor.forEach((c, i) => { html += `<tr><td>${i+1}º</td><td>${c.m}</td><td>${c.n}</td><td><strong>${formatTime(c.t)}</strong></td><td style="font-size:0.8em;">${formatTime(c.h.a)}|${formatTime(c.h.p)}|${formatTime(c.h.e75)}|${formatTime(c.h.e80)}|${formatTime(c.h.e100)}</td></tr>`; totalHorasTop3Setor += c.t; });
                    html += `</tbody><tfoot><tr><td colspan="3"><strong>Total Horas Top 3:</strong></td><td colspan="2"><strong>${formatTime(totalHorasTop3Setor)}</strong></td></tr></tfoot></table></div>`;
                 }
                 let comparativoTurnosSetorHtml = ""; let dadosComparativoTurnoSetor = null; const filtroT1 = filtro.filter(r => r.turno === '1'); const filtroT2 = filtro.filter(r => r.turno === '2');
                 if (filtroT1.length > 0 && filtroT2.length > 0) {
                    let tH1=filtroT1.reduce((a,r)=>a+Object.values(r.horas).reduce((s,h)=>s+h,0),0); let tH2=filtroT2.reduce((a,r)=>a+Object.values(r.horas).reduce((s,h)=>s+h,0),0); let diffH=Math.abs(tH1-tH2); let maiorT=tH1>=tH2?'1º':'2º'; let maiorTot=Math.max(tH1,tH2); let diffP=maiorTot>0?((diffH/maiorTot)*100):0; let cT1=new Set(filtroT1.map(r=>r.matricula)).size; let cT2=new Set(filtroT2.map(r=>r.matricula)).size;
                    comparativoTurnosSetorHtml = `<div class="shift-comparison-section"><h4>Comparativo 1º vs 2º Turno (${nomeSetorDisplay})</h4><p><strong>1º T:</strong> ${formatTime(tH1)} (${cT1} colab.)</p><p><strong>2º T:</strong> ${formatTime(tH2)} (${cT2} colab.)</p><p><strong>Diferença:</strong> ${formatTime(diffH)} (${diffP.toFixed(1)}% a mais no ${maiorT} Turno)</p><canvas id="sectorShiftChart"></canvas></div>`;
                    dadosComparativoTurnoSetor = { t1: { total: tH1, data: filtroT1 }, t2: { total: tH2, data: filtroT2 } };
                 } html += comparativoTurnosSetorHtml;
                 let justDepartamento = justificativaDepartamento[setorSelValue] || "";
                 html += `<div class="management-section"><h4>Justificativa do Setor</h4><textarea id="justificativaDept" placeholder="Descreva aqui o motivo das horas extras neste setor...">${justDepartamento}</textarea><div class="action-buttons"><button class="action save" onclick="salvarJustificativaDept('${setorSelValue}')">Salvar Just.</button><button class="action delete" onclick="excluirJustificativaDept('${setorSelValue}')">Excluir Just.</button></div></div>`;
                 let planoDepartamento = planoAcaoDepartamento[setorSelValue] || "";
                 html += `<div class="management-section"><h4>Plano de Ação do Setor</h4><textarea id="planoAcaoDept" placeholder="Descreva aqui o plano de ação específico para reduzir/controlar horas neste setor...">${planoDepartamento}</textarea><div class="action-buttons"><button class="action save" onclick="salvarPlanoAcaoDept('${setorSelValue}')">Salvar Plano</button><button class="action delete" onclick="excluirPlanoAcaoDept('${setorSelValue}')">Excluir Plano</button></div></div>`;
                 container.innerHTML = html;
                 currentReportType = 'setor';
                 currentReportData = { registros: filtro, totalHorasTop3: totalHorasTop3Setor, comparativoTurnos: dadosComparativoTurnoSetor, justificativaSetor: justDepartamento, planoSetor: planoDepartamento };
                 gerarGraficoPrincipal(filtro, "reportChart");
                 if(dadosComparativoTurnoSetor) gerarGraficoComparacaoTurnos(dadosComparativoTurnoSetor.t1.data, dadosComparativoTurnoSetor.t2.data, 'sectorShiftChart');
                 const deleteBtn = document.getElementById("deleteSectorDataButton");
                 deleteBtn.style.display = 'inline-block';
                 deleteBtn.onclick = () => excluirDadosPorSetor(setorSelValue);
            } else if (tipo === "geral") {
                 titulo = "Relatório Geral Consolidado"; filtro = registros; if (!filtro.length) { container.innerHTML = "<p>Não há registros para gerar o relatório geral.</p>"; currentReportType = null; return; }
                 let totalGeralMinutos = filtro.reduce((acc, r) => acc + Object.values(r.horas).reduce((s, h) => s + (h || 0), 0), 0); currentReportTitle = `${titulo} | Total Geral: ${formatTime(totalGeralMinutos)}`; html = `<h3 style="margin-bottom: 10px;">${currentReportTitle}</h3>`;
                 let horasPorSetor = {}; let colaboradoresPorSetor = {}; filtro.forEach(r => { let sl = r.setor.toLowerCase(); let tr = Object.values(r.horas).reduce((s,h)=>s+h,0); horasPorSetor[sl] = (horasPorSetor[sl] || 0) + tr; if(!colaboradoresPorSetor[sl]) colaboradoresPorSetor[sl]={}; let k=r.matricula; if(!colaboradoresPorSetor[sl][k]) colaboradoresPorSetor[sl][k]={m:r.matricula, n:r.nome, t:0}; colaboradoresPorSetor[sl][k].t+=tr; });
                 let setoresOrdenados = Object.entries(horasPorSetor).sort(([,a],[,b])=>b-a); let topSectorInfo = setoresOrdenados.length>0?setoresOrdenados[0]:null;
                 if (topSectorInfo) { const tsl=topSectorInfo[0]; const tsm=topSectorInfo[1]; const tsd=tsl.charAt(0).toUpperCase()+tsl.slice(1); html += `<div class="highlight-box"><h4>🏆 Setor Destaque (Maior Volume de Horas)</h4><p>Setor: <strong>${tsd}</strong> | Total: <strong>${formatTime(tsm)}</strong>.</p></div>`; let cTopS=Object.values(colaboradoresPorSetor[tsl]||{}).sort((a,b)=>b.t-a.t).slice(0,3); if(cTopS.length>0){ let topCHtml=`<h5 style="margin-top:10px;">Top Colaboradores em ${tsd}</h5><div class="table-container" style="margin-top:5px;"><table><thead><tr><th>Pos</th><th>Mat</th><th>Nome</th><th>Total (Horas no Setor)</th></tr></thead><tbody>`; cTopS.forEach((c,i)=>{topCHtml+=`<tr><td>${i+1}º</td><td>${c.m}</td><td>${c.n}</td><td><strong>${formatTime(c.t)}</strong></td></tr>`;}); topCHtml+=`</tbody></table></div>`; html+=topCHtml; } }
                 if (setoresOrdenados.length > 1 && topSectorInfo) { const tsm=topSectorInfo[1]; const tsd=topSectorInfo[0].charAt(0).toUpperCase()+topSectorInfo[0].slice(1); html += `<h4 style="margin-top: 20px;">Comparativo de Horas por Setor</h4><div class="table-container"><table><thead><tr><th>Pos</th><th>Setor</th><th>Total Horas</th><th>Diferença p/ ${tsd}</th><th>% Menos</th></tr></thead><tbody>`; setoresOrdenados.forEach(([sl,sm],i)=>{ const sd=sl.charAt(0).toUpperCase()+sl.slice(1); let dt='-'; let pt='-'; if(sl!==topSectorInfo[0]){ let dm=tsm-sm; dt=formatTime(dm)+' a menos'; if(tsm>0&&dm>=0){ pt=((dm/tsm)*100).toFixed(1)+'%'; } else { pt='N/A'; } } html+=`<tr><td>${i+1}º</td><td>${sd}</td><td><strong>${formatTime(sm)}</strong></td><td>${dt}</td><td>${pt}</td></tr>`; }); html+=`</tbody></table></div>`; }
                 let rankingGeral={}; filtro.forEach(r=>{ let k=r.matricula; let tC=Object.values(r.horas).reduce((s,h)=>s+h,0); if(!rankingGeral[k]) rankingGeral[k]={m:r.matricula,n:r.nome,s:r.setor,t:0,h:{a:0,p:0,e75:0,e80:0,e100:0}}; rankingGeral[k].t+=tC; rankingGeral[k].h.a+=(r.horas.anti||0); rankingGeral[k].h.p+=(r.horas.por||0); rankingGeral[k].h.e75+=(r.horas.extra75||0); rankingGeral[k].h.e80+=(r.horas.extra80||0); rankingGeral[k].h.e100+=(r.horas.extra100||0); rankingGeral[k].s=r.setor; }); let top3Geral = Object.values(rankingGeral).sort((a,b)=>b.t-a.t).slice(0,3); let totalHorasTop3Geral = 0;
                 if(top3Geral.length > 0){ html += `<h4 style="margin-top: 20px;">Top 3 Colaboradores (Geral - Todas as Horas)</h4><div class="table-container"><table><thead><tr><th>Pos</th><th>Mat</th><th>Nome</th><th>Setor Principal</th><th>Total Geral</th><th>Detalhes(A|P|75|80|100)</th></tr></thead><tbody>`; top3Geral.forEach((c,i)=>{ html += `<tr><td>${i+1}º</td><td>${c.m}</td><td>${c.n}</td><td>${c.s}</td><td><strong>${formatTime(c.t)}</strong></td><td style="font-size:0.8em;">${formatTime(c.h.a)}|${formatTime(c.h.p)}|${formatTime(c.h.e75)}|${formatTime(c.h.e80)}|${formatTime(c.h.e100)}</td></tr>`; totalHorasTop3Geral+=c.t; }); html += `</tbody><tfoot><tr><td colspan="4"><strong>Total Horas Top 3:</strong></td><td colspan="2"><strong>${formatTime(totalHorasTop3Geral)}</strong></td></tr></tfoot></table></div>`; }
                 html += `<h4 style="margin-top: 20px;">Resumo de Horas por Setor</h4><div class="table-container"><table><thead><tr><th>Pos</th><th>Setor</th><th>Total Horas</th></tr></thead><tbody>`; setoresOrdenados.forEach(([sl,tm],i)=>{ html += `<tr><td>${i+1}º</td><td>${sl.charAt(0).toUpperCase()+sl.slice(1)}</td><td><strong>${formatTime(tm)}</strong></td></tr>`; }); html += `</tbody></table></div>`;
                 html += `<div class="management-section"><h4>Plano de Ação Geral</h4><textarea id="planoAcaoGeralInput" placeholder="Descreva aqui o plano de ação geral para a empresa/unidade...">${planoAcaoGeral}</textarea><div class="action-buttons"><button class="action save" onclick="salvarPlanoAcaoGeral()">Salvar</button><button class="action delete" onclick="excluirPlanoAcaoGeral()">Excluir</button></div></div>`;
                 container.innerHTML = html; currentReportType = 'geral'; currentReportData = { registros: filtro, horasPorSetor: horasPorSetor, setoresOrdenados: setoresOrdenados, colaboradoresPorSetor: colaboradoresPorSetor, rankingGeral: rankingGeral, totalGeralMinutos: totalGeralMinutos, topSectorInfo: topSectorInfo, totalHorasTop3Geral: totalHorasTop3Geral };
                 gerarGraficoPrincipal(filtro, "reportChart"); gerarGraficoSetores(horasPorSetor, "sectorChart");
            } else if (tipo === 'comparativoTurnos') {
                 titulo = "Comparativo Geral - 1º vs 2º Turno"; const rT1=registros.filter(r=>r.turno==='1'); const rT2=registros.filter(r=>r.turno==='2'); if(rT1.length===0&&rT2.length===0){ container.innerHTML=`<p>Não há dados suficientes dos turnos 1 e 2 para comparação.</p>`; currentReportType=null; return; } let tH1=rT1.reduce((a,r)=>a+Object.values(r.horas).reduce((s,h)=>s+h,0),0); let tH2=rT2.reduce((a,r)=>a+Object.values(r.horas).reduce((s,h)=>s+h,0),0); let tHG=tH1+tH2; let pT1=tHG>0?(tH1/tHG*100):0; let pT2=tHG>0?(tH2/tHG*100):0; let dH=Math.abs(tH1-tH2); let mT=tH1>=tH2?'1º':'2º'; let mTot=Math.max(tH1,tH2); let dP=mTot>0?((dH/mTot)*100):0; let cT1=new Set(rT1.map(r=>r.matricula)).size; let cT2=new Set(rT2.map(r=>r.matricula)).size; let hST1={}; rT1.forEach(r=>{let s=r.setor.toLowerCase(); hST1[s]=(hST1[s]||0)+Object.values(r.horas).reduce((sum,h)=>sum+h,0);}); let hST2={}; rT2.forEach(r=>{let s=r.setor.toLowerCase(); hST2[s]=(hST2[s]||0)+Object.values(r.horas).reduce((sum,h)=>sum+h,0);}); let sDT1=Object.entries(hST1).sort(([,a],[,b])=>b-a)[0]; let sDT2=Object.entries(hST2).sort(([,a],[,b])=>b-a)[0];
                 currentReportTitle = `${titulo} | Total (1º+2º): ${formatTime(tHG)}`; html = `<h3 style="margin-bottom: 10px;">${currentReportTitle}</h3><div class="shift-comparison-section" style="border:none; background:none; padding:0;"><h4>Resumo Geral</h4><p><strong>1º Turno:</strong> ${formatTime(tH1)} (${pT1.toFixed(1)}% do total) | ${cT1} Colaboradores distintos</p><p><strong>2º Turno:</strong> ${formatTime(tH2)} (${pT2.toFixed(1)}% do total) | ${cT2} Colaboradores distintos</p>`;
                 if(tH1!==tH2){html+=`<p><strong>Diferença:</strong> ${formatTime(dH)} (${dP.toFixed(1)}% a mais no ${mT} Turno)</p>`;} else {html+=`<p>Os totais de horas dos dois turnos são iguais.</p>`;}
                 html+=`<h5 style="margin-top:15px;">Setores Destaque (Maior Volume por Turno):</h5>`;
                 if(sDT1) html+=`<p><strong>1º T:</strong> ${sDT1[0].charAt(0).toUpperCase()+sDT1[0].slice(1)} (${formatTime(sDT1[1])})</p>`; else html+=`<p><strong>1º T:</strong> Sem dados de setor para este turno.</p>`;
                 if(sDT2) html+=`<p><strong>2º T:</strong> ${sDT2[0].charAt(0).toUpperCase()+sDT2[0].slice(1)} (${formatTime(sDT2[1])})</p>`; else html+=`<p><strong>2º T:</strong> Sem dados de setor para este turno.</p>`;
                 html+=`<canvas id="geralShiftChart"></canvas></div>`;
                 container.innerHTML = html; currentReportType = 'comparativoTurnos'; currentReportData = { t1:{total:tH1, registros:rT1, colabCount:cT1, topSetor:sDT1}, t2:{total:tH2, registros:rT2, colabCount:cT2, topSetor:sDT2} };
                 gerarGraficoComparacaoTurnos(rT1, rT2, 'geralShiftChart');
            }

            if (currentReportType) { document.getElementById("exportButtonContainer").style.display = 'flex'; }

        } catch (error) { console.error("Erro ao gerar relatório:", error); container.innerHTML = `<p style='color: red;'>Ocorreu um erro ao gerar o relatório: ${error.message}. Verifique o console para mais detalhes.</p>`; currentReportType = null; hideChartsAndExportButton(); }
    }

    // --- Funções de Justificativa e Exclusão de Setor ---
    function salvarJustificativaDept(setorLowercase) { const t=document.getElementById("justificativaDept"); if(t){ justificativaDepartamento[setorLowercase]=t.value; salvarEstado(); alert(`Justificativa para o setor "${setorLowercase}" salva com sucesso!`); } else { alert("Erro: Campo de justificativa do departamento não encontrado."); } }
    function excluirJustificativaDept(setorLowercase) { if (confirm(`Tem certeza que deseja excluir a justificativa para o setor "${setorLowercase}"?`)) { delete justificativaDepartamento[setorLowercase]; const t=document.getElementById("justificativaDept"); if(t) t.value=""; salvarEstado(); alert(`Justificativa para o setor "${setorLowercase}" excluída com sucesso!`); } }
    function salvarJustificativaIndividualModal() { const m=document.getElementById("modalMatricula")?.textContent; const t=document.getElementById(`modalIndividualJustificationInput`); if (m && t) { justificativaIndividual[m]=t.value; salvarEstado(); const d=document.getElementById('modalIndividualJustificationDisplay'); if(d){ d.textContent=t.value||"Nenhuma justificativa individual associada."; d.style.display=t.value?'block':'none';} alert(`Justificativa individual para a matrícula ${m} salva com sucesso!`); } else { alert("Erro: Matrícula ou campo de justificativa individual não encontrado no modal."); } }
    function excluirJustificativaIndividualModal() { const m=document.getElementById("modalMatricula")?.textContent; if (m && confirm(`Tem certeza que deseja excluir a justificativa individual para a matrícula ${m}?`)) { delete justificativaIndividual[m]; const t=document.getElementById(`modalIndividualJustificationInput`); const d=document.getElementById('modalIndividualJustificationDisplay'); if(t) t.value=""; if(d){ d.textContent="Nenhuma justificativa individual associada."; d.style.display='none'; } salvarEstado(); alert(`Justificativa individual para a matrícula ${m} excluída com sucesso!`); } else if(!m){ alert("Erro: Matrícula não encontrada no modal."); } }

    function excluirDadosPorSetor(setorLower) {
        const nomeSetorDisplay = setorLower.charAt(0).toUpperCase() + setorLower.slice(1);
        const registrosDoSetor = registros.filter(r => r.setor.toLowerCase() === setorLower);
        if (registrosDoSetor.length === 0) {
            alert(`Não há registros para excluir do setor "${nomeSetorDisplay}".`);
            return;
        }
        if (confirm(`ATENÇÃO!\n\nTem certeza que deseja excluir TODOS os ${registrosDoSetor.length} registros de horas extras do setor "${nomeSetorDisplay}"?\n\nESTA AÇÃO NÃO PODE SER DESFEITA FACILMENTE (apenas pelo botão 'Desfazer' imediatamente após a exclusão, antes de fechar o programa).`)) {
             if (confirm(`SEGUNDA CONFIRMAÇÃO:\n\nRealmente excluir todos os dados do setor "${nomeSetorDisplay}"? Não haverá volta fácil após esta confirmação.`)) {
                const tamanhoAntes = registros.length;
                registros = registros.filter(r => r.setor.toLowerCase() !== setorLower);
                if (registros.length < tamanhoAntes) {
                    salvarEstado();
                    alert(`${tamanhoAntes - registros.length} registros do setor "${nomeSetorDisplay}" foram excluídos com sucesso.\nUse o botão 'Desfazer' imediatamente se isso foi um erro.`);
                    document.getElementById("reportContent").innerHTML = "<p>Dados do setor excluídos. Selecione outro relatório ou setor.</p>";
                    hideChartsAndExportButton();
                    document.getElementById("reportSetorSelect").value = "";
                    populateSetorDropdowns();
                    currentReportType = null;
                    currentReportSetor = "";
                } else {
                    alert(`Nenhum registro encontrado para o setor "${nomeSetorDisplay}" para excluir (isso não deveria acontecer neste ponto).`);
                }
             } else {
                 alert("Exclusão cancelada (segunda confirmação não realizada).");
             }
        } else {
            alert("Exclusão cancelada.");
        }
    }

    // Salvar / Excluir Planos de Ação
    function salvarPlanoAcaoGeral(){ planoAcaoGeral=document.getElementById("planoAcaoGeralInput").value; salvarEstado(); alert("Plano de Ação Geral salvo com sucesso!");}
    function excluirPlanoAcaoGeral(){ if(confirm("Tem certeza que deseja excluir o Plano de Ação Geral?")){ planoAcaoGeral=""; if(document.getElementById("planoAcaoGeralInput"))document.getElementById("planoAcaoGeralInput").value=""; salvarEstado(); alert("Plano de Ação Geral excluído com sucesso!");}}
    function salvarPlanoAcaoDept(setorLowercase){ let t=document.getElementById("planoAcaoDept").value; planoAcaoDepartamento[setorLowercase]=t; salvarEstado(); alert(`Plano de ação para o setor "${setorLowercase}" salvo com sucesso!`);}
    function excluirPlanoAcaoDept(setorLowercase){ if(confirm(`Tem certeza que deseja excluir o plano de ação para o setor "${setorLowercase}"?`)){ delete planoAcaoDepartamento[setorLowercase]; if(document.getElementById("planoAcaoDept"))document.getElementById("planoAcaoDept").value=""; salvarEstado(); alert(`Plano de ação para o setor "${setorLowercase}" excluído com sucesso!`);}}
    function salvarPlanoAcaoIndividualModal() { const m=document.getElementById("modalMatricula")?.textContent; const t=document.getElementById(`modalPlanoAcaoIndTextarea`); if(m&&t){ planoAcaoIndividual[m]=t.value; salvarEstado(); const d=document.getElementById('modalIndividualPlanDisplay'); if(d){d.textContent=t.value||"Nenhum plano de ação individual associado."; d.style.display=t.value?'block':'none';} alert(`Plano de ação individual para a matrícula ${m} salvo com sucesso!`); } else { alert("Erro: Matrícula ou campo de plano de ação individual não encontrado no modal."); } }
    function excluirPlanoAcaoIndividualModal() { const m=document.getElementById("modalMatricula")?.textContent; if(m&&confirm(`Tem certeza que deseja excluir o plano de ação individual para a matrícula ${m}?`)){ delete planoAcaoIndividual[m]; const t=document.getElementById(`modalPlanoAcaoIndTextarea`); const d=document.getElementById('modalIndividualPlanDisplay'); if(t)t.value=""; if(d){d.textContent="Nenhum plano de ação individual associado."; d.style.display='none';} salvarEstado(); alert(`Plano de ação individual para a matrícula ${m} excluído com sucesso!`); } else if(!m){ alert("Erro: Matrícula não encontrada no modal."); } }

    // --- Geração de Gráficos ---
    function gerarGraficoPrincipal(dados, canvasId) { const canvas = document.getElementById(canvasId); if (!canvas) return; if (canvasId === 'reportChart' && chartInstanceReport) { chartInstanceReport.destroy(); chartInstanceReport = null; } else if (canvasId === 'employeeChart' && chartInstanceEmployee) { chartInstanceEmployee.destroy(); chartInstanceEmployee = null; } let sA=0, sP=0, s75=0, s80=0, s100=0; if (dados && dados.length > 0) { dados.forEach(r => { if (r && r.horas) { sA+=(r.horas.anti||0); sP+=(r.horas.por||0); s75+=(r.horas.extra75||0); s80+=(r.horas.extra80||0); s100+=(r.horas.extra100||0); }}); } const hasData = sA > 0 || sP > 0 || s75 > 0 || s80 > 0 || s100 > 0; if (!hasData) { canvas.style.display = 'none'; return; } canvas.style.display = 'block'; const ctx = canvas.getContext("2d"); const chartData = { labels: ['HE Anti 50%', 'HE Pós 50%', 'HE 75%', 'HE 80%', 'HE 100%'], datasets: [{ label: 'Total Minutos', data: [sA, sP, s75, s80, s100], backgroundColor: ['rgba(0, 123, 255, 0.7)','rgba(40, 167, 69, 0.7)','rgba(255, 193, 7, 0.7)','rgba(111, 66, 193, 0.7)','rgba(220, 53, 69, 0.7)'], borderColor: ['rgba(0, 123, 255, 1)','rgba(40, 167, 69, 1)','rgba(255, 193, 7, 1)','rgba(111, 66, 193, 1)','rgba(220, 53, 69, 1)'], borderWidth: 1 }] }; const chartOptions = { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Total Minutos Acumulados' } }, x: { title: { display: false } } }, plugins: { legend: { display: false }, title: { display: true, text: 'Distribuição por Tipo de Hora Extra (Minutos)' }, tooltip: { callbacks: { label: function(context) { let l=context.dataset.label||''; if(l)l+=': '; if(context.parsed.y!==null)l+=formatTime(context.parsed.y); return l; } } } } }; if (canvasId === 'reportChart') chartInstanceReport = new Chart(ctx, { type: 'bar', data: chartData, options: chartOptions }); else if (canvasId === 'employeeChart') chartInstanceEmployee = new Chart(ctx, { type: 'bar', data: chartData, options: chartOptions }); }
    function gerarGraficoSetores(horasPorSetorObj, canvasId) { const canvas = document.getElementById(canvasId); if (!canvas) return; if (chartInstanceSector) { chartInstanceSector.destroy(); chartInstanceSector = null; } const setoresComHoras = Object.entries(horasPorSetorObj || {}).filter(([, total]) => total > 0); if (setoresComHoras.length === 0) { canvas.style.display = 'none'; return; } canvas.style.display = 'block'; const ctx = canvas.getContext("2d"); const labels = setoresComHoras.map(([sl]) => sl.charAt(0).toUpperCase() + sl.slice(1)); const data = setoresComHoras.map(([, total]) => total); const bgColors = generateColors(labels.length); const chartData = { labels: labels, datasets: [{ label: 'Horas por Setor (Minutos)', data: data, backgroundColor: bgColors, hoverOffset: 4 }] }; const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels:{ boxWidth: 12, padding: 15 } }, title: { display: true, text: 'Proporção de Horas Extras Totais por Setor' }, tooltip: { callbacks: { label: function(context) { let l=context.label||''; let v=context.parsed||0; let t=context.dataset.data.reduce((a,b)=>a+b,0); let p=t>0?((v/t)*100).toFixed(1)+'%':'0%'; return `${l}: ${formatTime(v)} (${p})`; } } } } }; chartInstanceSector = new Chart(ctx, { type: 'doughnut', data: chartData, options: chartOptions }); }
    function generateColors(count) { const colors = []; const baseHue = 195; const hueStep = 360 / Math.max(count, 1); for (let i = 0; i < count; i++) { const hue = (baseHue + i * hueStep) % 360; colors.push(`hsla(${hue}, 70%, 60%, 0.7)`); } return colors; }
    function gerarGraficoComparacaoTurnos(dadosTurno1, dadosTurno2, canvasId) { const canvas = document.getElementById(canvasId); if (!canvas) return; if (canvasId === 'sectorShiftChart' && chartInstanceSectorShift) { chartInstanceSectorShift.destroy(); chartInstanceSectorShift = null; } else if (canvasId === 'geralShiftChart' && chartInstanceGeralShift) { chartInstanceGeralShift.destroy(); chartInstanceGeralShift = null; } const processShiftData = (dados)=>{let s={a:0,p:0,e75:0,e80:0,e100:0}; dados.forEach(r=>{if(r&&r.horas){s.a+=(r.horas.anti||0); s.p+=(r.horas.por||0); s.e75+=(r.horas.extra75||0); s.e80+=(r.horas.extra80||0); s.e100+=(r.horas.extra100||0);}}); return [s.a,s.p,s.e75,s.e80,s.e100];}; const dataT1 = processShiftData(dadosTurno1); const dataT2 = processShiftData(dadosTurno2); const hasData = dataT1.some(d=>d>0) || dataT2.some(d=>d>0); if(!hasData){canvas.style.display='none';return;} canvas.style.display='block'; const ctx=canvas.getContext('2d'); const labels=['Anti 50%','Pós 50%','HE 75%','HE 80%','HE 100%']; const chartData={labels: labels, datasets:[{label:'1º Turno (Min)', data:dataT1, backgroundColor:'rgba(54, 162, 235, 0.7)', borderColor:'rgba(54, 162, 235, 1)', borderWidth:1},{label:'2º Turno (Min)', data:dataT2, backgroundColor:'rgba(255, 99, 132, 0.7)', borderColor:'rgba(255, 99, 132, 1)', borderWidth:1}]}; const chartOptions={responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true, title:{display:true, text:'Total Minutos por Tipo'}}}, plugins:{legend:{position:'top'}, title:{display:true, text:'Comparativo Horas por Tipo (1º vs 2º Turno)'}, tooltip:{callbacks:{label: function(c){let l=c.dataset.label||''; if(l)l+=': '; if(c.parsed.y!==null)l+=formatTime(c.parsed.y); return l;}}}}}; if(canvasId==='sectorShiftChart'){chartInstanceSectorShift=new Chart(ctx,{type:'bar',data:chartData,options:chartOptions});} else if(canvasId==='geralShiftChart'){chartInstanceGeralShift=new Chart(ctx,{type:'bar',data:chartData,options:chartOptions});} }

    // --- Exportação PDF (com Justificativas/Planos e Totais) ---
    async function exportCurrentReport() { /* ... código existente sem alterações ... */ }

    // --- Modal e Exportação Individual (Modal) ---
    function viewEmployeeDetails(registro) { /* ... código sem alterações ... */ }
    function closeEmployeeModal() { /* ... código sem alterações ... */ }

    async function exportEmployeeReport() { /* ... código existente sem alterações ... */ }

    // ==================================================
    // ==  FUNÇÕES PARA IMPORTAR E EXPORTAR JSON E APAGAR TUDO ==
    // ==================================================

    function exportarDadosJSON() {
        try {
            const dadosParaExportar = {
                versao: "3.2",
                dataExportacao: new Date().toISOString(),
                registros: registros,
                planoAcaoGeral: planoAcaoGeral,
                planoAcaoDepartamento: planoAcaoDepartamento,
                planoAcaoIndividual: planoAcaoIndividual,
                justificativaDepartamento: justificativaDepartamento,
                justificativaIndividual: justificativaIndividual
            };
            const jsonString = JSON.stringify(dadosParaExportar, null, 2);
            const blob = new Blob([jsonString], { type: "application/json" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            link.download = `analisador_horas_extras_dados_${timestamp}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            alert("Arquivo JSON com os dados exportado com sucesso!");
        } catch (error) {
            console.error("Erro ao exportar dados JSON:", error);
            alert(`Ocorreu um erro ao exportar os dados: ${error.message}`);
        }
    }

    function iniciarImportacaoJSON() {
        document.getElementById('importFile').click();
    }

    function importarDadosJSON(event) {
        const file = event.target.files[0];
        if (!file) { return; }
        if (!file.type.includes("json") && !file.name.toLowerCase().endsWith(".json")) {
            alert("Por favor, selecione um arquivo .json válido exportado anteriormente deste programa.");
            event.target.value = null;
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            const jsonString = e.target.result;
            try {
                const dadosImportados = JSON.parse(jsonString);
                if (!dadosImportados || typeof dadosImportados !== 'object' || !Array.isArray(dadosImportados.registros)) {
                     throw new Error("O arquivo JSON não parece ter a estrutura esperada.");
                }
                if (!confirm("ATENÇÃO!\n\nVocê está prestes a importar dados de um arquivo.\nIsso substituirá TODOS os registros, planos e justificativas existentes neste navegador.\n\nDeseja continuar?")) {
                    alert("Importação cancelada.");
                    event.target.value = null;
                    return;
                }
                registros = dadosImportados.registros || [];
                planoAcaoGeral = dadosImportados.planoAcaoGeral || "";
                planoAcaoDepartamento = dadosImportados.planoAcaoDepartamento || {};
                planoAcaoIndividual = dadosImportados.planoAcaoIndividual || {};
                justificativaDepartamento = dadosImportados.justificativaDepartamento || {};
                justificativaIndividual = dadosImportados.justificativaIndividual || {};
                registros.forEach(r => {
                     r.horas = r.horas || {};
                     r.horas.anti = Number(r.horas.anti) || 0;
                     r.horas.por = Number(r.horas.por) || 0;
                     r.horas.extra75 = Number(r.horas.extra75) || 0;
                     r.horas.extra80 = Number(r.horas.extra80) || 0;
                     r.horas.extra100 = Number(r.horas.extra100) || 0;
                     if (r.setor) r.setor = r.setor.charAt(0).toUpperCase() + r.setor.slice(1).toLowerCase();
                     else r.setor = "Indefinido";
                     if (!r.turno) { r.turno = "Geral"; }
                     if (!r.id) {
                        r.id = Date.now().toString(36) + Math.random().toString(36).substr(2, 5) + "_imported";
                     }
                 });
                undoStack = [];
                redoStack = [];
                salvarEstado(true);
                populateSetorDropdowns();
                showSection('dataEntry');
                limparFormulario();
                document.getElementById("searchResults").innerHTML = "";
                document.getElementById("reportContent").innerHTML = "";
                hideChartsAndExportButton();
                alert("Dados importados com sucesso! Todos os dados anteriores foram substituídos.");
            } catch (error) {
                console.error("Erro ao importar dados JSON:", error);
                alert(`Ocorreu um erro ao processar o arquivo JSON: ${error.message}\n\nVerifique se o arquivo está correto e foi gerado por este programa.`);
            } finally {
                 event.target.value = null;
            }
        };
        reader.onerror = function(e) {
            console.error("Erro ao ler o arquivo:", e);
            alert("Ocorreu um erro ao tentar ler o arquivo selecionado.");
             event.target.value = null;
        };
        reader.readAsText(file);
     }

     function apagarTodosOsDados() {
        if (confirm("ATENÇÃO!\n\nTem certeza que deseja apagar TODOS OS DADOS (registros, planos, justificativas) salvos neste navegador?\n\nEsta ação é IRREVERSÍVEL, a menos que você tenha um backup JSON para importar.")) {
            if (confirm("SEGUNDA CONFIRMAÇÃO:\n\nRealmente apagar TUDO? Não será possível recuperar os dados após esta confirmação (exceto por importação JSON).")) {
                try {
                    registros = [];
                    planoAcaoGeral = "";
                    planoAcaoDepartamento = {};
                    planoAcaoIndividual = {};
                    justificativaDepartamento = {};
                    justificativaIndividual = {};
                    undoStack = [];
                    redoStack = [];
                    salvarEstado(true);
                    populateSetorDropdowns();
                    limparFormulario();
                    if (document.getElementById("searchEdit").style.display === 'block') {
                        document.getElementById("searchResults").innerHTML = "";
                        document.getElementById("searchQuery").value = "";
                    }
                    if (document.getElementById("reports").style.display === 'block') {
                         document.getElementById("reportContent").innerHTML = "";
                         hideChartsAndExportButton();
                         document.getElementById("reportSetorSelect").value = "";
                         document.getElementById("setorReportDiv").style.display = "none";
                    }
                     showSection('dataEntry');
                    alert("Todos os dados foram apagados com sucesso.");
                } catch (error) {
                    console.error("Erro ao apagar todos os dados:", error);
                    alert(`Ocorreu um erro ao tentar apagar os dados: ${error.message}`);
                }
            } else {
                alert("Operação cancelada (segunda confirmação não realizada).");
            }
        } else {
            alert("Operação cancelada.");
        }
     }
  </script>
</body>
</html>
